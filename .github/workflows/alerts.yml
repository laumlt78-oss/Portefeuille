import yfinance as yf
import pandas as pd
import requests
import os
import sys

# Configuration des secrets
USER_KEY = os.getenv("PUSHOVER_USER_KEY")
API_TOKEN = os.getenv("PUSHOVER_API_TOKEN")
GH_REPO = os.getenv("GH_REPO")
MODE = sys.argv[1] if len(sys.argv) > 1 else "check"

def send_push(title, message, priority=0):
    print(f"--- Envoi Pushover : {title} ---")
    payload = {
        "token": API_TOKEN,
        "user": USER_KEY,
        "title": title,
        "message": message,
        "priority": priority
    }
    r = requests.post("https://api.pushover.net/1/messages.json", data=payload)
    print(f"R√©ponse : {r.status_code}")

# 1. Lecture du fichier
url = f"https://raw.githubusercontent.com/{GH_REPO}/main/portefeuille_data.csv"
print(f"Lien : {url}")

try:
    df = pd.read_csv(url)
    print(f"Actions trouvees : {len(df)}")
except Exception as e:
    print(f"Erreur lecture CSV : {e}")
    sys.exit()

total_achat = 0
total_actuel = 0
report_news = ""
alertes_envoyees = 0

# 2. Analyse
for _, row in df.iterrows():
    try:
        tk = yf.Ticker(row['Ticker'])
        price = tk.fast_info.last_price
        if price is None or price == 0:
            price = tk.history(period="1d")['Close'].iloc[-1]
            
        pru = float(row['PRU'])
        qte = float(row['Qt√©'])
        total_achat += (pru * qte)
        total_actuel += (price * qte)

        if MODE == "check":
            if price <= float(row['Seuil_Bas']):
                send_push("‚ö†Ô∏è ALERTE BASSE", f"{row['Nom']} : {price:.2f}‚Ç¨")
                alertes_envoyees += 1
            elif float(row.get('Seuil_Haut', 0)) > 0 and price >= float(row['Seuil_Haut']):
                send_push("üöÄ OBJECTIF", f"{row['Nom']} : {price:.2f}‚Ç¨")
                alertes_envoyees += 1

        if MODE == "close":
            n = tk.news
            if n: report_news += f"- {row['Nom']} : {n[0]['title']}\n"
    except:
        continue

# 3. Rapport
perf = ((total_actuel - total_achat) / total_achat * 100) if total_achat > 0 else 0

if MODE == "open":
    send_push("üîî OUVERTURE", f"Valeur : {total_actuel:.2f}‚Ç¨\nPerf : {perf:+.2f}%")
elif MODE == "close":
    send_push("üèÅ CLOTURE", f"Valeur : {total_actuel:.2f}‚Ç¨\n{report_news}")
elif MODE == "check":
    if alertes_envoyees == 0:
        send_push("‚úÖ Robot OK", f"Analyse finie. Portefeuille : {total_actuel:.2f}‚Ç¨")
