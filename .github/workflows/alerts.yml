import yfinance as yf
import pandas as pd
import requests
import os
import sys

# Configuration des secrets
USER_KEY = os.getenv("PUSHOVER_USER_KEY")
API_TOKEN = os.getenv("PUSHOVER_API_TOKEN")
GH_REPO = os.getenv("GH_REPO")
MODE = sys.argv[1] if len(sys.argv) > 1 else "check"

def send_push(title, message, priority=0):
    print(f"--- Tentative d'envoi Pushover : {title} ---")
    r = requests.post("https://api.pushover.net/1/messages.json", data={
        "token": API_TOKEN, "user": USER_KEY, "title": title, "message": message, "priority": priority
    })
    print(f"R√©ponse Pushover : {r.status_code} {r.text}")

# 1. Tentative de lecture du fichier
url = f"https://raw.githubusercontent.com/{GH_REPO}/main/portefeuille_data.csv"
print(f"Lecture du fichier √† l'adresse : {url}")

try:
    df = pd.read_csv(url)
    print(f"Fichier charg√© avec succ√®s. Nombre de lignes trouv√©es : {len(df)}")
except Exception as e:
    print(f"ERREUR LECTURE FICHIER : {e}")
    sys.exit()

total_achat = 0
total_actuel = 0
report_news = ""
alertes_detectees = 0

# 2. Analyse des actions
for _, row in df.iterrows():
    try:
        tk = yf.Ticker(row['Ticker'])
        price = tk.fast_info.last_price
        if price is None or price == 0:
            price = tk.history(period="1d")['Close'].iloc[-1]
            
        print(f"Analyse {row['Nom']} ({row['Ticker']}) : Prix = {price:.2f}‚Ç¨")
        
        pru = float(row['PRU'])
        qte = float(row['Qt√©'])
        total_achat += (pru * qte)
        total_actuel += (price * qte)

        if MODE == "check":
            if price <= float(row['Seuil_Bas']):
                send_push("‚ö†Ô∏è SEUIL BAS ATTEINT", f"{row['Nom']} : {price:.2f}‚Ç¨", 1)
                alertes_detectees += 1
            elif float(row.get('Seuil_Haut', 0)) > 0 and price >= float(row['Seuil_Haut']):
                send_push("üöÄ OBJECTIF ATTEINT", f"{row['Nom']} : {price:.2f}‚Ç¨", 1)
                alertes_detectees += 1

        if MODE == "close":
            news = tk.news
            if news:
                report_news += f"- {row['Nom']} : {news[0]['title']}\n"
    except Exception as e:
        print(f"Erreur sur le titre {row.get('Ticker')} : {e}")
        continue

# 3. Logique d'envoi
perf_globale = ((total_actuel - total_achat) / total_achat * 100) if total_achat > 0 else 0

if MODE == "open":
    send_push("üîî OUVERTURE BOURSE", f"Valeur : {total_actuel:.2f}‚Ç¨\nPerf : {perf_globale:+.2f}%")

elif MODE == "close":
    msg = f"Valeur Finale : {total_actuel:.2f}‚Ç¨\nPerf : {perf_globale:+.2f}%\n\nüì∞ NEWS :\n{report_news}"
    send_push("üèÅ CL√îTURE BOURSE", msg)

elif MODE == "check":
    if alertes_detectees == 0:
        # C'EST ICI QUE NOUS FOR√áONS LA CONFIRMATION
        print("Aucun seuil touch√©. Envoi d'une confirmation de bon fonctionnement...")
        send_push("‚úÖ Robot Actif", f"Analyse termin√©e. Aucun seuil touch√© sur vos {len(df)} actions.")
    else:
        print(f"Analyse termin√©e. {alertes_detectees} alerte(s) envoy√©e(s).")
